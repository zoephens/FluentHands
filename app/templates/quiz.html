{% extends 'base.html' %}

{% block css %} 
<link rel="stylesheet" href="{{ url_for('static', filename='css/text.css') }}">
{% endblock%}

{% block dashboard_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-xl-12 mb-4">
            <!-- Unified container for quizzes -->
            <div class="learning-materials-section" style="margin-left: 200px; margin-right: 200px">
                <div class="quizdiv">
                    <div class="quizzes-container">
                        <div class="quiz-header">
                            <h2>Quiz {{ quizzes[0].quiz_id }}: {{ quizzes[0].topic }}</h2>
                        </div>
                        <div id="question-container">

                        </div> <!-- Placeholder for questions -->
                        <div class="navigation-buttons">
                            <button class="prev-button"><i class="fa fa-chevron-left"></i> Previous</button>
                            <button class="next-button"><i class="fa fa-chevron-right"></i> Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %} 
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic@0.5.1675471629/holistic.min.js"></script>
<script>
    //Mediapipe tings
    const video = document.getElementById('video_feed');
    let label = document.getElementById('label');
    let value = ""
    mediapipe = window;

    // Function to send keypoints data to the backend
    const sendKeypointsData = (data) => {
        fetch('http://127.0.0.1:8080/keypoints', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Data sent:', data);
            value = data.predicted_label

            if (value !== "") {
                label.textContent = value
            }
        })
        .catch(error => {
            console.error('Error sending data:', error);
        });
    };

    // MediaPipe setup
    const { Holistic } = mediapipe;
    const holistic = new Holistic({
        locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`;
        },
    });
    holistic.setOptions({
        upperBodyOnly: false,  // Include keypoints for face, both hands, and pose
        smoothLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5,
    });

    // In browser camera
    const camera = new mediapipe.Camera(video, {
        onFrame: async () => {
            await holistic.send({ image: video });
        },
        width: 750,
        height: 500,
    });
    camera.start();        

    // Function for keypoints
    let sequence = []

    function extractKeypoints(results) {
        const pose = results.poseLandmarks ? results.poseLandmarks.map(res => [res.x, res.y, res.z, res.visibility]).flat() : Array(33 * 4).fill(0);
        const face = results.faceLandmarks ? results.faceLandmarks.map(res => [res.x, res.y, res.z]).flat() : Array(468 * 3).fill(0);
        const lh = results.leftHandLandmarks ? results.leftHandLandmarks.map(res => [res.x, res.y, res.z]).flat() : Array(21 * 3).fill(0);
        const rh = results.rightHandLandmarks ? results.rightHandLandmarks.map(res => [res.x, res.y, res.z]).flat() : Array(21 * 3).fill(0);
        return pose.concat(face, lh, rh);
    }
    
    holistic.onResults((results) => {
        if (results.faceLandmarks && results.poseLandmarks && (results.leftHandLandmarks || results.rightHandLandmarks)) {
            let landmarksToSend = extractKeypoints(results);

            sequence.push(landmarksToSend)
            sequence = sequence.slice(sequence.length - 60)
            //console.log(sequence)
            if (sequence.length == 30)
                sendKeypointsData(sequence);
        }            
    });


    // navigation
    const quizzes = '{{ quizzes | tojson | safe }}';
    if (quizzes.length > 0) { // Assuming there's at least one quiz object in the array
        const quizData = quizzes[0]; // Access the first quiz object
        let allQuestions = [
            ...(Array.isArray(quizData.camera_questions) ? quizData.camera_questions : []),
            ...(Array.isArray(quizData.image_questions) ? quizData.image_questions : [])
        ];

        let currentQuestionIndex = 0;

        function displayQuestion(index) {
            const question = allQuestions[index];
            const quizContainer = document.getElementById('question-container');
            let contentHTML = '';
            console.log()
            if (question.type === 'Camera') {
                contentHTML = `<div class="question">
                    <h3>Question ${index + 1}: ${question.text}</h3>
                    <video id="video_feed" autoplay style="width: 100%; height: auto;"></video>
                    <p>Mark(s): ${question.marks}</p>
                </div>`;
            } else if (question.type === 'Image') {
                contentHTML = `<div class="question">
                    <h3>Question ${index + 1}: ${question.text}</h3>
                    <img src="../static/images/${question.image_url}" alt="Quiz Image" style="max-width: 100%; height: auto;">
                    <p>Mark(s): ${question.marks}</p>
                </div>`;
            }

            quizContainer.innerHTML = contentHTML;
            updateNavigationButtons();
        }

    function updateNavigationButtons() {
        document.querySelector('.prev-button').disabled = currentQuestionIndex === 0;
        document.querySelector('.next-button').disabled = currentQuestionIndex === allQuestions.length - 1;
    }
    
    function nextQuestion() {
        if (currentQuestionIndex < allQuestions.length - 1) {
            currentQuestionIndex++;
            displayQuestion(currentQuestionIndex);
        }
    }

    function prevQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            displayQuestion(currentQuestionIndex);
        }
    }

    // Initialize with the first question
    document.querySelector('.next-button').addEventListener('click', nextQuestion);
    document.querySelector('.prev-button').addEventListener('click', prevQuestion);

    document.addEventListener('DOMContentLoaded', () => {
        displayQuestion(currentQuestionIndex);
    });
    } else {
        console.error('No quiz data available');
    }
</script>
{% endblock %}